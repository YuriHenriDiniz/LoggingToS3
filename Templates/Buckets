AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Dois buckets S3 (versionados, SSE-S3, Object Lock Governance com retenção padrão)
  + Lifecycle rules (transições/expiração) + BucketPolicies.

Parameters:
  BucketOneName:
    Type: String
    Description: Nome do bucket 1

  BucketTwoName:
    Type: String
    Description: Nome do bucket 2

  RootArn:
    Type: String
    Description: ARN do root permitido

  RsyslogRoleArn:
    Type: String
    Description: ARN da role do rsyslog

  AuditRoleArn:
    Type: String
    Description: ARN da role de auditoria

  RetentionDays:
    Type: Number
    Default: 90
    MinValue: 1
    MaxValue: 166
    ConstraintDescription: >
      RetentionDays não pode ser maior que 166 dias,
      pois o BucketTwo expira objetos nesse prazo.
    Description: Retenção padrão (em dias) do Object Lock em modo GOVERNANCE

Resources:

  BucketOne:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketOneName

      ObjectLockEnabled: true
      ObjectLockConfiguration:
        ObjectLockEnabled: Enabled
        Rule:
          DefaultRetention:
            Mode: GOVERNANCE
            Days: !Ref RetentionDays

      VersioningConfiguration:
        Status: Enabled

      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

      LifecycleConfiguration:
        Rules:
          - Id: CurrentVersion-IA45-DeepArchive165-Expire731
            Status: Enabled
            Filter: {} # bucket inteiro
            Transitions:
              - StorageClass: STANDARD_IA
                TransitionInDays: 45
              - StorageClass: DEEP_ARCHIVE
                TransitionInDays: 165
            ExpirationInDays: 731

  BucketOnePolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref BucketOne
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyBucketAccess
            Effect: Deny
            NotPrincipal:
              AWS:
                - !Ref RootArn
                - !Ref RsyslogRoleArn
                - !Ref AuditRoleArn
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${BucketOneName}"
              - !Sub "arn:aws:s3:::${BucketOneName}/*"

          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${BucketOneName}"
              - !Sub "arn:aws:s3:::${BucketOneName}/*"
            Condition:
              Bool:
                aws:SecureTransport: false

          - Sid: AllowRsyslogAccess
            Effect: Allow
            Principal:
              AWS: !Ref RsyslogRoleArn
            Action:
              - s3:PutObject
              - s3:AbortMultipartUpload
            Resource: !Sub "arn:aws:s3:::${BucketOneName}/*"

          - Sid: AllowRsyslogAccessBkt
            Effect: Allow
            Principal:
              AWS: !Ref RsyslogRoleArn
            Action: s3:ListBucket
            Resource: !Sub "arn:aws:s3:::${BucketOneName}"

          - Sid: AllowAuditAccessBkt
            Effect: Allow
            Principal:
              AWS: !Ref AuditRoleArn
            Action:
              - s3:ListBucket
              - s3:GetBucketLocation
            Resource: !Sub "arn:aws:s3:::${BucketOneName}"

          - Sid: AllowAuditAccess
            Effect: Allow
            Principal:
              AWS: !Ref AuditRoleArn
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
            Resource: !Sub "arn:aws:s3:::${BucketOneName}/*"

  BucketTwo:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketTwoName

      ObjectLockEnabled: true
      ObjectLockConfiguration:
        ObjectLockEnabled: Enabled
        Rule:
          DefaultRetention:
            Mode: GOVERNANCE
            Days: !Ref RetentionDays

      VersioningConfiguration:
        Status: Enabled

      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

      LifecycleConfiguration:
        Rules:
          - Id: CurrentVersion-IA45-Expire166
            Status: Enabled
            Filter: {} # bucket inteiro
            Transitions:
              - StorageClass: STANDARD_IA
                TransitionInDays: 45
            ExpirationInDays: 166

  BucketTwoPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref BucketTwo
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyBucketAccess
            Effect: Deny
            NotPrincipal:
              AWS:
                - !Ref RootArn
                - !Ref RsyslogRoleArn
                - !Ref AuditRoleArn
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${BucketTwoName}"
              - !Sub "arn:aws:s3:::${BucketTwoName}/*"

          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${BucketTwoName}"
              - !Sub "arn:aws:s3:::${BucketTwoName}/*"
            Condition:
              Bool:
                aws:SecureTransport: false

          - Sid: AllowRsyslogAccess
            Effect: Allow
            Principal:
              AWS: !Ref RsyslogRoleArn
            Action:
              - s3:PutObject
              - s3:AbortMultipartUpload
            Resource: !Sub "arn:aws:s3:::${BucketTwoName}/*"

          - Sid: AllowRsyslogAccessBkt
            Effect: Allow
            Principal:
              AWS: !Ref RsyslogRoleArn
            Action: s3:ListBucket
            Resource: !Sub "arn:aws:s3:::${BucketTwoName}"

          - Sid: AllowAuditAccessBkt
            Effect: Allow
            Principal:
              AWS: !Ref AuditRoleArn
            Action:
              - s3:ListBucket
              - s3:GetBucketLocation
            Resource: !Sub "arn:aws:s3:::${BucketTwoName}"

          - Sid: AllowAuditAccess
            Effect: Allow
            Principal:
              AWS: !Ref AuditRoleArn
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
            Resource: !Sub "arn:aws:s3:::${BucketTwoName}/*"

Outputs:
  BucketOneOut:
    Value: !Ref BucketOne
    Description: Bucket 1

  BucketTwoOut:
    Value: !Ref BucketTwo
    Description: Bucket 2
