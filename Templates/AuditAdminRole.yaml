AWSTemplateFormatVersion: "2010-09-09"
Description: >
    Template para criar a role administrativa
    que tem controle total sobre os dois buckets.
    
Parameters:

    AuditAdminRoleName:
       Type: String
       Default: AuditAdminRole
       Description: Nome da role.
       
    LoggingBucketName:
       Type: String
       Description: arn do bucket principal.
       
    LoggingBucketSrtName:
       Type: String
       Description: arn do bucket-srt.
       
    TrustedIdentityArn:
       Type: String
       Description: arn da identidade confi√°vel.
       
    ManagedPolicyName:
       Type: String
       Description: nome da politica anexada a role.
       
Resources:
    AuditAdminRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: !Ref AuditAdminRoleName
        ManagedPolicyArns:
         - !Ref AuditRoleManagedPolicy
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
           - Sid: AuditAdminRoleTrust
             Effect: Allow
             Principal: 
              AWS: !Ref TrustedIdentityArn
             Action:
              - sts:AssumeRole
            
    AuditRoleManagedPolicy:
      Type: AWS::IAM::ManagedPolicy
      Properties:
         ManagedPolicyName: !Ref ManagedPolicyName
         PolicyDocument:
            Version: "2012-10-17"
            Statement:
             - Sid: AuditRoleManagedPolicy
               Effect: Allow
               Action:
                - s3:*
               Resources:
                - !Sub "arn:aws:s3:::${LoggingBucketName}"
                - !Sub "arn:aws:s3:::${LoggingBucketSrtName}"
                - !Sub "arn:aws:s3:::${LoggingBucketName}/*"
                - !Sub "arn:aws:s3:::${LoggingBucketSrtName}/*"

Outputs:
  AuditRoleArn:
    Description: Retorna o arn da role AuditAdminRole.
    Value: !GetAtt AuditAdminRole.Arn
